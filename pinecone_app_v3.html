<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enercon Knowledge Base</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .datetime { color: #888; font-size: 0.9em; display: flex; align-items: center; gap: 15px; }
        .datetime i { color: #f39c12; }
        .header-actions { display: flex; gap: 10px; }
        .btn-icon { background: #2d2d44; border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s; }
        .btn-icon:hover { background: #f39c12; transform: scale(1.1); }
        .btn-ai { background: linear-gradient(135deg, #9b59b6, #3498db); animation: glow 2s ease-in-out infinite; }
        .btn-ai:hover { background: linear-gradient(135deg, #8e44ad, #2980b9); }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #9b59b6; } 50% { box-shadow: 0 0 20px #9b59b6, 0 0 30px #3498db; } }
        header h1 { font-size: 2.2em; background: linear-gradient(90deg, #f39c12, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #2d2d44; border-radius: 20px; font-size: 0.9em; margin-top: 10px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #e74c3c; }
        .status-dot.connected { background: #2ecc71; }
        .auto-sync-badge { background: #27ae60; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; margin-left: 10px; display: none; }
        .auto-sync-badge.active { display: inline; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 18px; background: #2d2d44; border: none; border-radius: 8px; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .tab:hover, .tab.active { background: linear-gradient(90deg, #f39c12, #e74c3c); }
        .panel { display: none; }
        .panel.active { display: block; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 15px 20px; font-size: 1.1em; border: none; border-radius: 8px; background: #2d2d44; color: #fff; outline: none; }
        .search-box input:focus { box-shadow: 0 0 0 2px #f39c12; }
        .btn { padding: 12px 24px; background: linear-gradient(90deg, #f39c12, #e74c3c); border: none; border-radius: 8px; color: #fff; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { transform: scale(1.02); }
        .btn:disabled { opacity: 0.5; }
        .btn-small { padding: 8px 16px; font-size: 0.9em; }
        .btn-green { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .btn-blue { background: linear-gradient(90deg, #2980b9, #3498db); }
        .btn-red { background: linear-gradient(90deg, #c0392b, #e74c3c); }
        .btn-purple { background: linear-gradient(90deg, #8e44ad, #9b59b6); }
        .results { display: grid; gap: 15px; }
        .result-card { background: #2d2d44; border-radius: 12px; padding: 20px; border-left: 4px solid #f39c12; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .result-title { font-size: 1.1em; color: #f39c12; }
        .result-score { background: #1a1a2e; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; }
        .result-category { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; margin-bottom: 10px; background: #3498db; }
        .result-category.email { background: #3498db; }
        .result-category.note { background: #9b59b6; }
        .result-category.panel { background: #27ae60; }
        .result-category.inverter { background: #9b59b6; }
        .result-category.battery { background: #e67e22; }
        .result-text { color: #aaa; font-size: 0.9em; line-height: 1.6; max-height: 150px; overflow: hidden; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #2d2d44; border-radius: 12px; padding: 30px; max-width: 900px; max-height: 85vh; overflow-y: auto; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .modal-title { font-size: 1.4em; color: #f39c12; display: flex; align-items: center; gap: 10px; }
        .modal-close { background: #e74c3c; border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .modal-body { color: #ccc; line-height: 1.8; }
        .modal-body h3 { color: #f39c12; margin: 20px 0 10px 0; }
        /* AI Assistant Styles */
        .ai-modal .modal-content { max-width: 700px; background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%); border: 1px solid #9b59b6; }
        .ai-header { text-align: center; margin-bottom: 20px; }
        .ai-header h2 { font-size: 1.8em; background: linear-gradient(90deg, #9b59b6, #3498db); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .ai-header p { color: #888; }
        .ai-options { display: grid; gap: 12px; }
        .ai-option { background: #1a1a2e; border: 1px solid #3d3d54; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 15px; }
        .ai-option:hover { border-color: #9b59b6; background: #252540; transform: translateX(5px); }
        .ai-option i { font-size: 1.5em; color: #9b59b6; width: 40px; text-align: center; }
        .ai-option h4 { color: #fff; margin-bottom: 3px; }
        .ai-option p { color: #888; font-size: 0.85em; margin: 0; }
        .ai-chat { margin-top: 20px; display: none; }
        .ai-chat.active { display: block; }
        .ai-messages { background: #1a1a2e; border-radius: 12px; padding: 15px; min-height: 200px; max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
        .ai-message { margin-bottom: 12px; padding: 10px 15px; border-radius: 12px; }
        .ai-message.user { background: #3498db; margin-left: 20%; }
        .ai-message.assistant { background: #2d2d44; margin-right: 20%; border-left: 3px solid #9b59b6; }
        .ai-input-row { display: flex; gap: 10px; }
        .ai-input-row input { flex: 1; padding: 12px 15px; border: none; border-radius: 8px; background: #1a1a2e; color: #fff; }
        .ai-suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .ai-suggestion { background: #3d3d54; padding: 6px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer; }
        .ai-suggestion:hover { background: #9b59b6; }
        /* Memory Stats */
        .memory-stats { background: #1a1a2e; border-radius: 12px; padding: 20px; margin-top: 15px; }
        .memory-bar { height: 20px; background: #3d3d54; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .memory-bar-fill { height: 100%; background: linear-gradient(90deg, #27ae60, #f39c12); border-radius: 10px; transition: width 0.5s; }
        .memory-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .memory-item { background: #2d2d44; padding: 12px; border-radius: 8px; text-align: center; }
        .memory-item i { font-size: 1.5em; color: #f39c12; margin-bottom: 5px; }
        .memory-item .value { font-size: 1.3em; font-weight: bold; color: #fff; }
        .memory-item .label { font-size: 0.8em; color: #888; }
        /* Other styles */
        .upload-zone { border: 3px dashed #444; border-radius: 12px; padding: 40px; text-align: center; background: #2d2d44; cursor: pointer; margin-bottom: 20px; }
        .upload-zone:hover { border-color: #f39c12; }
        .upload-zone i { font-size: 2em; color: #f39c12; }
        .upload-zone input { display: none; }
        .file-item { display: flex; justify-content: space-between; background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .category-select { width: 100%; padding: 12px; border: none; border-radius: 8px; background: #1a1a2e; color: #fff; margin-bottom: 15px; }
        .email-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; padding: 15px; background: #2d2d44; border-radius: 12px; }
        .filter-group label { display: flex; align-items: center; gap: 6px; color: #888; margin-bottom: 5px; font-size: 0.85em; }
        .filter-group select, .filter-group input { width: 100%; padding: 8px; border: none; border-radius: 6px; background: #1a1a2e; color: #fff; }
        .email-actions { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .email-item { background: #2d2d44; border-radius: 8px; padding: 12px 15px; margin-bottom: 10px; display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; cursor: pointer; }
        .email-item:hover { background: #3d3d54; }
        .email-checkbox { width: 20px; height: 20px; accent-color: #f39c12; }
        .sync-log { background: #1a1a2e; padding: 12px; border-radius: 8px; max-height: 150px; overflow-y: auto; font-size: 0.8em; }
        .sync-log .success { color: #2ecc71; }
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-top: 15px; }
        .doc-card { background: #2d2d44; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .doc-card .delete-btn { background: #e74c3c; border: none; color: #fff; padding: 5px 8px; border-radius: 5px; cursor: pointer; }
        .notes-container { display: grid; grid-template-columns: 250px 1fr; gap: 20px; min-height: 450px; }
        .notes-list { background: #2d2d44; border-radius: 12px; padding: 15px; }
        .note-item { padding: 12px; background: #1a1a2e; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border-left: 3px solid transparent; }
        .note-item:hover, .note-item.active { border-left-color: #f39c12; }
        .note-editor { background: #2d2d44; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        .note-editor input { background: #1a1a2e; border: none; padding: 12px; border-radius: 8px; color: #fff; margin-bottom: 10px; }
        .note-editor textarea { flex: 1; background: #1a1a2e; border: none; padding: 15px; border-radius: 8px; color: #fff; resize: none; min-height: 250px; }
        .note-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .calendar-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .calendar-main { background: #2d2d44; border-radius: 12px; padding: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .calendar-nav button { background: #1a1a2e; border: none; color: #fff; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin: 2px; }
        .calendar-nav button:hover { background: #f39c12; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { text-align: center; padding: 10px; color: #888; font-weight: bold; }
        .calendar-day { text-align: center; padding: 8px; background: #1a1a2e; border-radius: 6px; cursor: pointer; min-height: 50px; position: relative; }
        .calendar-day:hover { background: #3d3d54; }
        .calendar-day.today { border: 2px solid #f39c12; }
        .calendar-day.selected { background: #f39c12; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; }
        .calendar-sidebar { background: #2d2d44; border-radius: 12px; padding: 20px; max-height: 600px; overflow-y: auto; }
        .event-item { background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #f39c12; position: relative; }
        .event-item .event-delete { position: absolute; top: 8px; right: 8px; background: #e74c3c; border: none; color: #fff; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; }
        .event-item.google { border-left-color: #4285f4; }
        .add-event-form { margin-top: 20px; padding-top: 15px; border-top: 1px solid #444; }
        .add-event-form input, .add-event-form textarea { width: 100%; background: #1a1a2e; border: none; padding: 10px; border-radius: 6px; color: #fff; margin-bottom: 8px; }
        .contacts-header { display: flex; gap: 10px; margin-bottom: 15px; }
        .contacts-search { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #2d2d44; color: #fff; }
        .contacts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .contact-card { background: #2d2d44; border-radius: 12px; padding: 15px; border-left: 4px solid #3498db; }
        .contact-card h3 { color: #f39c12; margin-bottom: 10px; }
        .contact-info span { display: flex; align-items: center; gap: 8px; color: #aaa; margin: 5px 0; }
        .contact-info a { color: #3498db; text-decoration: none; }
        .settings-section { background: #2d2d44; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .settings-section h3 { color: #f39c12; margin-bottom: 15px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #3d3d54; }
        .setting-item:last-child { border-bottom: none; }
        .setting-item small { color: #888; display: block; margin-top: 3px; }
        .toggle { width: 50px; height: 26px; background: #1a1a2e; border-radius: 13px; position: relative; cursor: pointer; }
        .toggle.active { background: #27ae60; }
        .toggle::after { content: ''; position: absolute; width: 22px; height: 22px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .toggle.active::after { left: 26px; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #27ae60; padding: 15px 25px; border-radius: 8px; display: none; z-index: 1001; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .loading-spinner { display: inline-block; width: 25px; height: 25px; border: 3px solid #444; border-top-color: #f39c12; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 900px) { .calendar-container, .notes-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="datetime">
                    <span><i class="fas fa-calendar"></i> <span id="currentDate"></span></span>
                    <span><i class="fas fa-clock"></i> <span id="currentTime"></span></span>
                </div>
                <div class="header-actions">
                    <button class="btn-icon btn-ai" onclick="showAI()" title="AI Assistant"><i class="fas fa-magic"></i></button>
                    <button class="btn-icon" onclick="showHelp()" title="Î’Î¿Î®Î¸ÎµÎ¹Î±"><i class="fas fa-question-circle"></i></button>
                    <button class="btn-icon" onclick="showPanel('settings')" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <h1><i class="fas fa-solar-panel"></i> Enercon Knowledge Base</h1>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
                <span id="statsText" style="color:#888;margin-left:10px;"></span>
                <span class="auto-sync-badge" id="autoSyncBadge"><i class="fas fa-sync-alt"></i> Auto</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showPanel('search')"><i class="fas fa-search"></i> Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
            <button class="tab" onclick="showPanel('upload')"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
            <button class="tab" onclick="showPanel('email')"><i class="fas fa-envelope"></i> Email</button>
            <button class="tab" onclick="showPanel('contacts')"><i class="fas fa-address-book"></i> Î•Ï€Î±Ï†Î­Ï‚</button>
            <button class="tab" onclick="showPanel('notes')"><i class="fas fa-sticky-note"></i> Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</button>
            <button class="tab" onclick="showPanel('calendar')"><i class="fas fa-calendar-alt"></i> Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿</button>
            <button class="tab" onclick="showPanel('docs')"><i class="fas fa-folder-open"></i> ÎˆÎ³Î³ÏÎ±Ï†Î±</button>
        </div>

        <!-- SEARCH -->
        <div id="searchPanel" class="panel active">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·... Ï€.Ï‡. inverter 10kw Ï„Î¹Î¼Î®">
                <button class="btn" onclick="doSearch()"><i class="fas fa-search"></i> Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
            </div>
            <div id="resultsCount" style="color:#888;margin-bottom:15px;"></div>
            <div id="results" class="results"></div>
        </div>

        <!-- UPLOAD -->
        <div id="uploadPanel" class="panel">
            <select class="category-select" id="uploadCategory">
                <option value="general">Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î·</option>
                <option value="pricelist">Î¤Î¹Î¼Î¿ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚</option>
                <option value="panel">Panel</option>
                <option value="inverter">Inverter</option>
                <option value="battery">Battery</option>
            </select>
            <div class="upload-zone" id="uploadZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Î£ÏÏÎµ Î‘ÏÏ‡ÎµÎ¯Î±</h3>
                <p>PDF, Excel, TXT</p>
                <input type="file" id="fileInput" multiple>
            </div>
            <div id="fileList"></div>
            <button class="btn" onclick="uploadAllFiles()" style="width:100%;"><i class="fas fa-upload"></i> Upload</button>
        </div>

        <!-- EMAIL -->
        <div id="emailPanel" class="panel">
            <div class="email-filters">
                <div class="filter-group"><label><i class="fas fa-folder"></i> ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label><select id="emailCategory"><option value="all">ÎŒÎ»ÎµÏ‚</option><option value="primary" selected>ÎšÏÏÎ¹Î±</option><option value="updates">Î•Î½Î·Î¼ÎµÏÏÏƒÎµÎ¹Ï‚</option><option value="sent">Î‘Ï€ÎµÏƒÏ„Î±Î»Î¼Î­Î½Î±</option></select></div>
                <div class="filter-group"><label><i class="fas fa-calendar"></i> Î—Î¼Î­ÏÎµÏ‚</label><select id="emailDays"><option value="7">7</option><option value="30" selected>30</option><option value="90">90</option></select></div>
                <div class="filter-group"><label><i class="fas fa-paperclip"></i> Î£Ï…Î½Î·Î¼Î¼Î­Î½Î±</label><select id="emailFilter"><option value="all">ÎŒÎ»Î±</option><option value="attachments">ÎœÎµ ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Î±</option></select></div>
                <div class="filter-group"><label><i class="fas fa-search"></i> Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</label><input type="text" id="emailSearch" placeholder="Ï€.Ï‡. bigsolar"></div>
            </div>
            <div class="email-actions">
                <button class="btn btn-blue" onclick="fetchEmails()"><i class="fas fa-download"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ·</button>
                <button class="btn btn-green" onclick="syncSelectedEmails()" id="btnSync" disabled><i class="fas fa-sync-alt"></i> Sync (<span id="selectedCount">0</span>)</button>
                <label style="color:#888;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"> ÎŒÎ»Î±</label>
                <span id="lastSyncTime" style="color:#888;font-size:0.85em;margin-left:auto;"></span>
            </div>
            <div id="syncStatus" style="display:none;"><div class="sync-log" id="syncLog"></div></div>
            <div id="emailList"><div class="loading"><i class="fas fa-info-circle"></i> Î Î±Ï„Î®ÏƒÏ„Îµ "Î¦ÏŒÏÏ„Ï‰ÏƒÎ·"</div></div>
        </div>

        <!-- CONTACTS -->
        <div id="contactsPanel" class="panel">
            <div class="contacts-header">
                <input type="text" class="contacts-search" id="contactsSearch" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎµÏ€Î±Ï†Î®Ï‚..." oninput="filterContacts()">
                <button class="btn btn-blue" onclick="fetchContacts()"><i class="fas fa-sync"></i> Î¦ÏŒÏÏ„Ï‰ÏƒÎ·</button>
            </div>
            <div id="contactsList" class="contacts-grid"><div class="loading"><i class="fas fa-info-circle"></i> Î Î±Ï„Î®ÏƒÏ„Îµ "Î¦ÏŒÏÏ„Ï‰ÏƒÎ·"</div></div>
        </div>

        <!-- NOTES -->
        <div id="notesPanel" class="panel">
            <div class="notes-container">
                <div class="notes-list">
                    <button class="btn btn-small" onclick="newNote()" style="width:100%;margin-bottom:15px;"><i class="fas fa-plus"></i> ÎÎ­Î±</button>
                    <div id="notesList"></div>
                </div>
                <div class="note-editor">
                    <input type="text" id="noteTitle" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚...">
                    <textarea id="noteContent" placeholder="Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·..."></textarea>
                    <div class="note-actions">
                        <button class="btn btn-green btn-small" onclick="saveNote()"><i class="fas fa-save"></i> Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
                        <button class="btn btn-red btn-small" onclick="deleteNote()"><i class="fas fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
                        <button class="btn btn-purple btn-small" onclick="syncNoteToRAG()"><i class="fas fa-brain"></i> Sync RAG</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALENDAR -->
        <div id="calendarPanel" class="panel">
            <div class="calendar-container">
                <div class="calendar-main">
                    <div class="calendar-header">
                        <h2 id="calendarMonth"></h2>
                        <div class="calendar-nav">
                            <button onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="goToday()">Î£Î®Î¼ÎµÏÎ±</button>
                            <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
                            <button class="btn btn-blue btn-small" onclick="fetchGoogleCalendar()"><i class="fab fa-google"></i> Sync</button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-header">ÎšÏ…Ï</div><div class="calendar-day-header">Î”ÎµÏ…</div><div class="calendar-day-header">Î¤ÏÎ¹</div><div class="calendar-day-header">Î¤ÎµÏ„</div><div class="calendar-day-header">Î ÎµÎ¼</div><div class="calendar-day-header">Î Î±Ï</div><div class="calendar-day-header">Î£Î±Î²</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
                <div class="calendar-sidebar">
                    <h3><i class="fas fa-list"></i> Events <span id="selectedDateLabel"></span></h3>
                    <div id="eventsList"></div>
                    <div class="add-event-form">
                        <h4 style="color:#888;margin-bottom:10px;"><i class="fas fa-plus"></i> ÎÎ­Î¿ Event</h4>
                        <input type="text" id="eventTitle" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"><input type="date" id="eventDate"><input type="time" id="eventTime"></div>
                        <textarea id="eventDesc" placeholder="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®..." rows="2"></textarea>
                        <button class="btn btn-green btn-small" onclick="addEvent()" style="width:100%;"><i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DOCS -->
        <div id="docsPanel" class="panel">
            <button class="btn" onclick="loadDocs()"><i class="fas fa-sync"></i> Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
            <div id="docsList" class="docs-grid"></div>
        </div>

        <!-- SETTINGS -->
        <div id="settingsPanel" class="panel">
            <div class="settings-section">
                <h3><i class="fas fa-envelope"></i> Email Auto-Sync</h3>
                <div class="setting-item">
                    <div><label>Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·</label><small>ÎšÎ¬Î¸Îµ 10 Î»ÎµÏ€Ï„Î¬</small></div>
                    <div class="toggle" id="toggleAutoSync" onclick="toggleAutoSync()"></div>
                </div>
                <div class="setting-item">
                    <div><label>Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ sync</label><small id="settingsLastSync">-</small></div>
                    <button class="btn btn-blue btn-small" onclick="manualSync()"><i class="fas fa-sync"></i> Sync</button>
                </div>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-database"></i> ÎœÎ½Î®Î¼Î· & Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</h3>
                <div class="memory-stats">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· Î¼Î½Î®Î¼Î·</span>
                        <span id="memoryPercent">0%</span>
                    </div>
                    <div class="memory-bar"><div class="memory-bar-fill" id="memoryBar" style="width:0%;"></div></div>
                    <div class="memory-details">
                        <div class="memory-item"><i class="fas fa-file-alt"></i><div class="value" id="memDocs">0</div><div class="label">ÎˆÎ³Î³ÏÎ±Ï†Î±</div></div>
                        <div class="memory-item"><i class="fas fa-envelope"></i><div class="value" id="memEmails">0</div><div class="label">Emails</div></div>
                        <div class="memory-item"><i class="fas fa-sticky-note"></i><div class="value" id="memNotes">0</div><div class="label">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</div></div>
                        <div class="memory-item"><i class="fas fa-calendar"></i><div class="value" id="memEvents">0</div><div class="label">Events</div></div>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h3><i class="fab fa-google"></i> Google APIs</h3>
                <div class="setting-item"><div><label>Gmail</label><small id="gmailStatus">-</small></div><span id="gmailIcon"></span></div>
                <div class="setting-item"><div><label>Calendar</label><small id="calendarStatus">-</small></div><span id="calendarIcon"></span></div>
                <div class="setting-item"><div><label>Contacts</label><small id="contactsStatus">-</small></div><span id="contactsIcon"></span></div>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-trash-alt"></i> Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</h3>
                <div class="setting-item"><div><label>Î¤Î¿Ï€Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</label><small>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚, Events</small></div><button class="btn btn-red btn-small" onclick="clearLocalData()"><i class="fas fa-trash"></i> Î”Î¹Î±Î³ÏÎ±Ï†Î®</button></div>
                <div class="setting-item"><div><label>Reset Token</label><small>ÎÎ­Î¿ Google login</small></div><button class="btn btn-red btn-small" onclick="resetToken()"><i class="fas fa-redo"></i> Reset</button></div>
            </div>
        </div>
    </div>

    <!-- AI ASSISTANT MODAL -->
    <div class="modal ai-modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title"><i class="fas fa-magic"></i> AI Assistant</span>
                <button class="modal-close" onclick="closeAI()"><i class="fas fa-times"></i></button>
            </div>
            <div class="ai-header">
                <h2>âœ¨ Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰;</h2>
                <p>Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼Î¹Î± ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± Î® ÏÏÏ„Î·ÏƒÎ­ Î¼Îµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ</p>
            </div>
            <div class="ai-options" id="aiOptions">
                <div class="ai-option" onclick="aiAction('search')">
                    <i class="fas fa-search"></i>
                    <div><h4>ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</h4><p>Î’ÏÎµÏ‚ Î­Î³Î³ÏÎ±Ï†Î±, emails, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</p></div>
                </div>
                <div class="ai-option" onclick="aiAction('organize')">
                    <i class="fas fa-layer-group"></i>
                    <div><h4>ğŸ“ ÎŸÏÎ³Î¬Î½Ï‰ÏƒÎ·</h4><p>Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ· & ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎµÎ³Î³ÏÎ¬Ï†Ï‰Î½</p></div>
                </div>
                <div class="ai-option" onclick="aiAction('quote')">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <div><h4>ğŸ’° Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬Ï‚</h4><p>Î£ÏÎ½Ï„Î±Î¾Î· Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬Ï‚ Î¼Îµ Ï„Î¹Î¼Î­Ï‚ Î±Ï€ÏŒ RAG</p></div>
                </div>
                <div class="ai-option" onclick="aiAction('sync')">
                    <i class="fas fa-sync-alt"></i>
                    <div><h4>ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</h4><p>Sync emails, calendar, contacts</p></div>
                </div>
                <div class="ai-option" onclick="aiAction('help')">
                    <i class="fas fa-life-ring"></i>
                    <div><h4>â“ Î’Î¿Î®Î¸ÎµÎ¹Î±</h4><p>Î ÏÏ‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ‰ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®</p></div>
                </div>
            </div>
            <div class="ai-chat" id="aiChat">
                <div class="ai-messages" id="aiMessages"></div>
                <div class="ai-input-row">
                    <input type="text" id="aiInput" placeholder="Î“ÏÎ¬ÏˆÎµ Ï„Î¿ ÎµÏÏÏ„Î·Î¼Î¬ ÏƒÎ¿Ï…..." onkeypress="if(event.key==='Enter')sendAI()">
                    <button class="btn btn-purple" onclick="sendAI()"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="ai-suggestions" id="aiSuggestions"></div>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div class="modal" id="helpModal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <span class="modal-title"><i class="fas fa-question-circle"></i> Î’Î¿Î®Î¸ÎµÎ¹Î±</span>
                <button class="modal-close" onclick="closeHelp()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <h3>Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹;</h3>
                <p>Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· & Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎµÎ³Î³ÏÎ¬Ï†Ï‰Î½, emails Î¼Îµ AI (RAG).</p>
                <h3>AI Assistant</h3>
                <p>Î Î¬Ï„Î± Ï„Î¿ âœ¨ Î³Î¹Î± Î½Î± ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Î® Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹Ï‚ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚.</p>
                <h3>Auto-Sync</h3>
                <p>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ â†’ Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Î³Î¹Î± Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ sync emails ÎºÎ¬Î¸Îµ 10 Î»ÎµÏ€Ï„Î¬.</p>
            </div>
        </div>
    </div>

    <!-- EMAIL MODAL -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="emailModalTitle"></span>
                <button class="modal-close" onclick="closeEmailModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="emailModalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let ws, pendingFiles=[], emailsData=[], selectedEmails=new Set(), contactsData=[], totalDocs=0;
        let notes = JSON.parse(localStorage.getItem('enercon_notes') || '[]');
        let events = JSON.parse(localStorage.getItem('enercon_events') || '[]');
        let settings = JSON.parse(localStorage.getItem('enercon_settings') || '{"autoSync":false}');
        let currentNoteId = null, currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear(), selectedDate = null;
        let autoSyncInterval = null, currentAIAction = null;

        // DateTime
        function updateDateTime() {
            const now = new Date();
            const days = ['ÎšÏ…ÏÎ¹Î±ÎºÎ®','Î”ÎµÏ…Ï„Î­ÏÎ±','Î¤ÏÎ¯Ï„Î·','Î¤ÎµÏ„Î¬ÏÏ„Î·','Î Î­Î¼Ï€Ï„Î·','Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®','Î£Î¬Î²Î²Î±Ï„Î¿'];
            const months = ['Î™Î±Î½Î¿Ï…Î±ÏÎ¯Î¿Ï…','Î¦ÎµÎ²ÏÎ¿Ï…Î±ÏÎ¯Î¿Ï…','ÎœÎ±ÏÏ„Î¯Î¿Ï…','Î‘Ï€ÏÎ¹Î»Î¯Î¿Ï…','ÎœÎ±ÎÎ¿Ï…','Î™Î¿Ï…Î½Î¯Î¿Ï…','Î™Î¿Ï…Î»Î¯Î¿Ï…','Î‘Ï…Î³Î¿ÏÏƒÏ„Î¿Ï…','Î£ÎµÏ€Ï„ÎµÎ¼Î²ÏÎ¯Î¿Ï…','ÎŸÎºÏ„Ï‰Î²ÏÎ¯Î¿Ï…','ÎÎ¿ÎµÎ¼Î²ÏÎ¯Î¿Ï…','Î”ÎµÎºÎµÎ¼Î²ÏÎ¯Î¿Ï…'];
            document.getElementById('currentDate').textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('el-GR');
        }
        setInterval(updateDateTime, 1000); updateDateTime();

        // WebSocket
        function connect() {
            ws = new WebSocket('ws://localhost:8765');
            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                ws.send(JSON.stringify({action:'stats'}));
                updateAPIStatus(true);
                if(settings.autoSync) startAutoSync();
            };
            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';
                setTimeout(connect, 3000);
            };
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                if(d.action==='search_results') displayResults(d.results);
                else if(d.action==='stats') { totalDocs=d.data.total_vectors; document.getElementById('statsText').textContent=`| ${totalDocs} docs`; updateMemoryStats(); }
                else if(d.action==='file_upload_success'){showToast(`Uploaded ${d.count}`);ws.send(JSON.stringify({action:'stats'}))}
                else if(d.action==='emails_loaded') displayEmails(d.emails);
                else if(d.action==='email_sync_success'){addSyncLog(d.subject,'success');ws.send(JSON.stringify({action:'stats'}))}
                else if(d.action==='email_sync_complete'){addSyncLog(`Done! ${d.count}`,'success');showToast(`Synced ${d.count}!`);updateLastSync()}
                else if(d.action==='list_results') displayDocs(d.docs);
                else if(d.action==='delete_success'){showToast('Deleted');loadDocs()}
                else if(d.action==='note_synced') showToast('Note synced!');
                else if(d.action==='calendar_events') displayGoogleEvents(d.events);
                else if(d.action==='contacts_loaded') displayContacts(d.contacts);
                else if(d.action==='error') showToast(d.message,true);
            };
        }

        function updateAPIStatus(ok){
            ['gmail','calendar','contacts'].forEach(api=>{
                document.getElementById(api+'Status').textContent = ok ? 'Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿' : 'Error';
                document.getElementById(api+'Icon').innerHTML = `<i class="fas fa-${ok?'check':'times'}-circle" style="color:${ok?'#27ae60':'#e74c3c'};"></i>`;
            });
        }

        function updateMemoryStats() {
            const maxDocs = 10000; // Pinecone free tier
            const percent = Math.min(100, (totalDocs / maxDocs) * 100);
            document.getElementById('memoryPercent').textContent = percent.toFixed(1) + '%';
            document.getElementById('memoryBar').style.width = percent + '%';
            document.getElementById('memDocs').textContent = totalDocs;
            document.getElementById('memNotes').textContent = notes.length;
            document.getElementById('memEvents').textContent = events.length;
            // Estimate emails (rough)
            document.getElementById('memEmails').textContent = Math.floor(totalDocs * 0.3);
        }

        // Panels
        function showPanel(n) {
            document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.getElementById(n+'Panel').classList.add('active');
            const tab = document.querySelector(`.tab[onclick="showPanel('${n}')"]`);
            if(tab) tab.classList.add('active');
            if(n==='docs')loadDocs();
            if(n==='notes')renderNotes();
            if(n==='calendar')renderCalendar();
            if(n==='settings'){loadSettings();updateMemoryStats();}
        }
        function showHelp(){document.getElementById('helpModal').classList.add('active')}
        function closeHelp(){document.getElementById('helpModal').classList.remove('active')}

        // AI Assistant
        function showAI() { document.getElementById('aiModal').classList.add('active'); document.getElementById('aiOptions').style.display='grid'; document.getElementById('aiChat').classList.remove('active'); }
        function closeAI() { document.getElementById('aiModal').classList.remove('active'); }
        
        function aiAction(action) {
            currentAIAction = action;
            document.getElementById('aiOptions').style.display = 'none';
            document.getElementById('aiChat').classList.add('active');
            document.getElementById('aiMessages').innerHTML = '';
            document.getElementById('aiSuggestions').innerHTML = '';
            
            let msg = '', suggestions = [];
            if(action === 'search') {
                msg = 'Î¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚; ÎœÏ€Î¿ÏÏ Î½Î± ÏˆÎ¬Î¾Ï‰ ÏƒÎµ Î­Î³Î³ÏÎ±Ï†Î±, emails, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚...';
                suggestions = ['Î¤Î¹Î¼Î­Ï‚ inverter', 'Emails Î±Ï€ÏŒ Big Solar', 'Î ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚ panels'];
            } else if(action === 'organize') {
                msg = 'Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± Î¿ÏÎ³Î±Î½ÏÏƒÏ‰ Ï„Î± Î­Î³Î³ÏÎ±Ï†Î¬ ÏƒÎ¿Ï…; ÎœÏ€Î¿ÏÏ Î½Î±:\nâ€¢ Î¤Î±Î¾Î¹Î½Î¿Î¼Î®ÏƒÏ‰ ÎºÎ±Ï„Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±\nâ€¢ Î’ÏÏ‰ Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î±\nâ€¢ Î ÏÎ¿Ï„ÎµÎ¯Î½Ï‰ tags';
                suggestions = ['Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ· ÏŒÎ»Ï‰Î½', 'Î’ÏÎµÏ‚ Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î±', 'Î ÏÎ¿Ï„ÎµÎ¯Î½Îµ tags'];
            } else if(action === 'quote') {
                msg = 'Î‘Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ Î¼Î¹Î± Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬! Î ÎµÏ‚ Î¼Î¿Ï…:\nâ€¢ Î¤Î¹ ÎµÎ¾Î¿Ï€Î»Î¹ÏƒÎ¼ÏŒ Î¸Î­Î»ÎµÎ¹Ï‚;\nâ€¢ Î ÏŒÏƒÎ± kW;\nâ€¢ ÎŒÎ½Î¿Î¼Î± Ï€ÎµÎ»Î¬Ï„Î·;';
                suggestions = ['5kW Î¿Î¹ÎºÎ¹Î±ÎºÏŒ', '10kW ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒ', '20kW Î²Î¹Î¿Î¼Î·Ï‡Î±Î½Î¹ÎºÏŒ'];
            } else if(action === 'sync') {
                msg = 'Î¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¯ÏƒÏ‰;\nâ€¢ Emails (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ 7 Î·Î¼Î­ÏÎµÏ‚)\nâ€¢ Google Calendar\nâ€¢ Î•Ï€Î±Ï†Î­Ï‚';
                suggestions = ['Sync Emails', 'Sync Calendar', 'Sync Î•Ï€Î±Ï†Î­Ï‚', 'Sync ÎŒÎ»Î±'];
            } else if(action === 'help') {
                msg = 'Î¡ÏÏ„Î± Î¼Îµ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®!\n\nğŸ“Œ **Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚:**\nâ€¢ Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· - Î’ÏÎµÏ‚ Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ\nâ€¢ Upload - Î‘Î½Î­Î²Î±ÏƒÎµ PDF/Excel\nâ€¢ Email - Î¦Î­ÏÎµ emails ÏƒÏ„Î¿ RAG\nâ€¢ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ - ÎšÏÎ¬Ï„Î± notes\nâ€¢ Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ - Events & Google sync';
                suggestions = ['Î ÏÏ‚ Î±Î½ÎµÎ²Î¬Î¶Ï‰ Î±ÏÏ‡ÎµÎ¯Î±;', 'Î ÏÏ‚ ÏƒÏ…Î½Î´Î­Ï‰ Gmail;', 'Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ RAG;'];
            }
            
            addAIMessage(msg, 'assistant');
            suggestions.forEach(s => {
                document.getElementById('aiSuggestions').innerHTML += `<span class="ai-suggestion" onclick="document.getElementById('aiInput').value='${s}';sendAI()">${s}</span>`;
            });
        }
        
        function addAIMessage(text, type) {
            const div = document.createElement('div');
            div.className = 'ai-message ' + type;
            div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            document.getElementById('aiMessages').appendChild(div);
            document.getElementById('aiMessages').scrollTop = 99999;
        }
        
        function sendAI() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if(!text) return;
            
            addAIMessage(text, 'user');
            input.value = '';
            document.getElementById('aiSuggestions').innerHTML = '';
            
            // Process AI response
            setTimeout(() => {
                let response = '';
                const lower = text.toLowerCase();
                
                if(currentAIAction === 'search' || lower.includes('ÏˆÎ¬Î¾Îµ') || lower.includes('Î²ÏÎµÏ‚')) {
                    response = `ğŸ” Î‘Î½Î±Î¶Î·Ï„Ï "${text}"...\n\nÎ Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î® Ï€Î¬Ï„Î± Enter ÎµÎ´Ï Î³Î¹Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.`;
                    // Auto search
                    document.getElementById('searchInput').value = text;
                    doSearch();
                } else if(currentAIAction === 'quote' || lower.includes('Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬')) {
                    response = `ğŸ’° Î“Î¹Î± Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ ${text}:\n\n1. Î¨Î¬Ï‡Î½Ï‰ Ï„Î¹Î¼Î­Ï‚ ÏƒÏ„Î¿ RAG...\n2. Î’ÏÎ®ÎºÎ± ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±\n3. Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î¹Ï‚ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î½Î± Ï†Ï„Î¹Î¬Î¾Ï‰ draft\n\n*Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÏ‰;*`;
                } else if(lower.includes('sync') || lower.includes('ÏƒÏ…Î³Ï‡ÏÎ¿Î½')) {
                    if(lower.includes('email')) { fetchEmails(); response = 'ğŸ“§ Î¦Î¿ÏÏ„ÏÎ½Ï‰ emails...'; }
                    else if(lower.includes('calendar')) { fetchGoogleCalendar(); response = 'ğŸ“… Sync Calendar...'; }
                    else if(lower.includes('ÎµÏ€Î±Ï†')) { fetchContacts(); response = 'ğŸ‘¥ Î¦Î¿ÏÏ„ÏÎ½Ï‰ ÎµÏ€Î±Ï†Î­Ï‚...'; }
                    else { fetchEmails(); fetchGoogleCalendar(); fetchContacts(); response = 'ğŸ”„ Sync ÏŒÎ»Ï‰Î½ ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·!'; }
                } else if(lower.includes('Î±Î½ÎµÎ²') || lower.includes('upload')) {
                    response = 'ğŸ“¤ Î“Î¹Î± Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹Ï‚ Î±ÏÏ‡ÎµÎ¯Î±:\n1. Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± **Upload**\n2. Î£ÏÏÎµ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î± Î® ÎºÎ¬Î½Îµ ÎºÎ»Î¹Îº\n3. Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±\n4. Î Î¬Ï„Î± Upload!';
                } else if(lower.includes('gmail') || lower.includes('google')) {
                    response = 'ğŸ”‘ Î“Î¹Î± ÏƒÏÎ½Î´ÎµÏƒÎ· Gmail:\n1. Google Cloud Console\n2. Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Gmail API\n3. Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ OAuth Desktop\n4. ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ credentials.json\n5. Î’Î¬Î»Ï„Î¿ ÏƒÏ„Î¿Î½ Ï†Î¬ÎºÎµÎ»Î¿';
                } else if(lower.includes('rag')) {
                    response = 'ğŸ§  **RAG** = Retrieval Augmented Generation\n\nÎ‘Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î± Î­Î³Î³ÏÎ±Ï†Î¬ ÏƒÎ¿Ï… ÏƒÎµ vectors ÎºÎ±Î¹ Ï„Î± Î±Î½Î±Î¶Î·Ï„Î¬ Î¼Îµ AI. ÎˆÏ„ÏƒÎ¹ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î²ÏÎµÎ¹Ï‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÏŒ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Î±ÎºÏŒÎ¼Î± ÎºÎ¹ Î±Î½ Î´ÎµÎ½ Î¸Ï…Î¼Î¬ÏƒÎ±Î¹ Î±ÎºÏÎ¹Î²ÏÏ‚ Ï„Î¹ Î­Î³ÏÎ±Ï†Îµ!';
                } else {
                    response = `ÎšÎ±Ï„Î¬Î»Î±Î²Î±! "${text}"\n\nÎœÏ€Î¿ÏÏ Î½Î± ÏƒÎµ Î²Î¿Î·Î¸Î®ÏƒÏ‰ Î¼Îµ:\nâ€¢ ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·\nâ€¢ ğŸ“ ÎŸÏÎ³Î¬Î½Ï‰ÏƒÎ·\nâ€¢ ğŸ’° Î ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚\nâ€¢ ğŸ”„ Sync\n\nÎ¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎºÎ¬Î½Î¿Ï…Î¼Îµ;`;
                }
                
                addAIMessage(response, 'assistant');
            }, 500);
        }

        // Auto-Sync
        function toggleAutoSync(){settings.autoSync=!settings.autoSync;localStorage.setItem('enercon_settings',JSON.stringify(settings));document.getElementById('toggleAutoSync').classList.toggle('active',settings.autoSync);document.getElementById('autoSyncBadge').classList.toggle('active',settings.autoSync);if(settings.autoSync)startAutoSync();else stopAutoSync();showToast(settings.autoSync?'Auto-sync ON':'Auto-sync OFF')}
        function startAutoSync(){if(autoSyncInterval)return;autoSyncInterval=setInterval(()=>{const d=new Date();d.setDate(d.getDate()-7);ws.send(JSON.stringify({action:'fetch_emails',query:`category:primary has:attachment after:${d.toISOString().split('T')[0]}`,max_results:20}))},10*60*1000);document.getElementById('autoSyncBadge').classList.add('active')}
        function stopAutoSync(){if(autoSyncInterval){clearInterval(autoSyncInterval);autoSyncInterval=null}document.getElementById('autoSyncBadge').classList.remove('active')}
        function manualSync(){fetchEmails();showToast('Syncing...')}
        function updateLastSync(){const t=new Date().toLocaleTimeString('el-GR');document.getElementById('lastSyncTime').textContent=`Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿: ${t}`;document.getElementById('settingsLastSync').textContent=t;settings.lastSync=Date.now();localStorage.setItem('enercon_settings',JSON.stringify(settings))}

        // Search
        function doSearch(){const q=document.getElementById('searchInput').value.trim();if(!q||!ws)return;document.getElementById('results').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';ws.send(JSON.stringify({action:'search',query:q,top_k:15}))}
        function displayResults(r){document.getElementById('resultsCount').textContent=r.length?`${r.length} Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±`:'';if(!r.length){document.getElementById('results').innerHTML='<div class="loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';return}document.getElementById('results').innerHTML=r.map(x=>`<div class="result-card"><div class="result-header"><span class="result-title">${x.title}</span><span class="result-score"><i class="fas fa-chart-line"></i> ${x.score}</span></div><span class="result-category ${x.category}"><i class="fas fa-tag"></i> ${x.category}</span><div class="result-text">${x.text}</div></div>`).join('')}

        // Email
        function fetchEmails(){const cat=document.getElementById('emailCategory').value,days=document.getElementById('emailDays').value,filt=document.getElementById('emailFilter').value,search=document.getElementById('emailSearch').value;document.getElementById('emailList').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';let q='';if(cat==='primary')q+='category:primary ';else if(cat==='updates')q+='category:updates ';else if(cat==='sent')q+='in:sent ';if(filt==='attachments')q+='has:attachment ';if(search)q+=search+' ';const d=new Date();d.setDate(d.getDate()-parseInt(days));q+=`after:${d.toISOString().split('T')[0]}`;ws.send(JSON.stringify({action:'fetch_emails',query:q.trim(),max_results:50}))}
        function displayEmails(emails){emailsData=emails;selectedEmails.clear();updateSelectedCount();if(!emails.length){document.getElementById('emailList').innerHTML='<div class="loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';return}document.getElementById('emailList').innerHTML=emails.map((e,i)=>`<div class="email-item" onclick="showEmailPreview(${i})"><input type="checkbox" class="email-checkbox" id="email-${i}" onclick="event.stopPropagation();toggleEmailCheckbox(${i})"><div><div style="color:#fff;">${e.subject}</div><div style="color:#888;font-size:0.8em;margin-top:4px;"><i class="fas fa-user"></i> ${e.from} | <i class="fas fa-calendar"></i> ${e.date}${e.attachments?` | <span style="background:#e74c3c;padding:2px 6px;border-radius:8px;font-size:0.7em;"><i class="fas fa-paperclip"></i> ${e.attachments}</span>`:''}</div></div><span style="padding:4px 10px;border-radius:12px;font-size:0.75em;background:${e.category==='primary'?'#27ae60':e.category==='sent'?'#9b59b6':'#3498db'};">${e.categoryLabel}</span></div>`).join('')}
        function toggleEmailCheckbox(i){selectedEmails.has(i)?selectedEmails.delete(i):selectedEmails.add(i);updateSelectedCount()}
        function toggleSelectAll(){const s=document.getElementById('selectAll').checked;emailsData.forEach((_,i)=>{s?selectedEmails.add(i):selectedEmails.delete(i);const cb=document.getElementById(`email-${i}`);if(cb)cb.checked=s});updateSelectedCount()}
        function updateSelectedCount(){document.getElementById('selectedCount').textContent=selectedEmails.size;document.getElementById('btnSync').disabled=!selectedEmails.size}
        function showEmailPreview(i){const e=emailsData[i];document.getElementById('emailModalTitle').innerHTML=`<i class="fas fa-envelope"></i> ${e.subject}`;document.getElementById('emailModalBody').innerHTML=`<p><b>Î‘Ï€ÏŒ:</b> ${e.from}</p><p><b>Î—Î¼:</b> ${e.date}</p><hr style="border-color:#444;margin:15px 0;"><div style="background:#1a1a2e;padding:15px;border-radius:8px;">${e.snippet}</div>`;document.getElementById('emailModal').classList.add('active')}
        function closeEmailModal(){document.getElementById('emailModal').classList.remove('active')}
        function syncSelectedEmails(){if(!selectedEmails.size)return;document.getElementById('syncStatus').style.display='block';document.getElementById('syncLog').innerHTML='';addSyncLog(`Sync ${selectedEmails.size}...`,'info');ws.send(JSON.stringify({action:'sync_emails',emails:Array.from(selectedEmails).map(i=>emailsData[i])}))}
        function addSyncLog(m,t='info'){const l=document.getElementById('syncLog'),e=document.createElement('div');e.className=t;e.innerHTML=`<i class="fas fa-${t==='success'?'check':'info'}-circle"></i> ${m}`;l.appendChild(e);l.scrollTop=l.scrollHeight}

        // Contacts
        function fetchContacts(){document.getElementById('contactsList').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';ws.send(JSON.stringify({action:'fetch_contacts'}))}
        function displayContacts(contacts){contactsData=contacts;if(!contacts.length){document.getElementById('contactsList').innerHTML='<div class="loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';return}renderContacts(contacts)}
        function renderContacts(list){document.getElementById('contactsList').innerHTML=list.map(c=>`<div class="contact-card"><h3><i class="fas fa-user"></i> ${c.name}</h3><div class="contact-info">${c.phones.map(p=>`<span><i class="fas fa-phone"></i> <a href="tel:${p}">${p}</a></span>`).join('')}${c.emails.map(e=>`<span><i class="fas fa-envelope"></i> <a href="mailto:${e}">${e}</a></span>`).join('')}${c.organization?`<span><i class="fas fa-building"></i> ${c.organization}</span>`:''}</div></div>`).join('')}
        function filterContacts(){const q=document.getElementById('contactsSearch').value.toLowerCase();renderContacts(contactsData.filter(c=>c.name.toLowerCase().includes(q)||c.emails.some(e=>e.toLowerCase().includes(q))||c.phones.some(p=>p.includes(q))))}

        // Notes
        function renderNotes(){document.getElementById('notesList').innerHTML=notes.map(n=>`<div class="note-item ${currentNoteId===n.id?'active':''}" onclick="loadNote('${n.id}')"><h4 style="margin-bottom:5px;">${n.title||'Î§Ï‰ÏÎ¯Ï‚ Ï„Î¯Ï„Î»Î¿'}</h4><small style="color:#888;">${new Date(n.updated).toLocaleDateString('el-GR')}</small></div>`).join('')||'<p style="color:#888;text-align:center;">ÎšÎ±Î¼Î¯Î±</p>'}
        function newNote(){currentNoteId=Date.now().toString();document.getElementById('noteTitle').value='';document.getElementById('noteContent').value='';renderNotes()}
        function loadNote(id){const n=notes.find(x=>x.id===id);if(n){currentNoteId=id;document.getElementById('noteTitle').value=n.title;document.getElementById('noteContent').value=n.content;renderNotes()}}
        function saveNote(){const t=document.getElementById('noteTitle').value.trim(),c=document.getElementById('noteContent').value.trim();if(!t&&!c)return showToast('Î“ÏÎ¬ÏˆÎµ ÎºÎ¬Ï„Î¹',true);const idx=notes.findIndex(n=>n.id===currentNoteId);const note={id:currentNoteId,title:t,content:c,updated:Date.now()};if(idx>=0)notes[idx]=note;else notes.unshift(note);localStorage.setItem('enercon_notes',JSON.stringify(notes));renderNotes();showToast('Saved!');updateMemoryStats()}
        function deleteNote(){if(!currentNoteId||!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))return;notes=notes.filter(n=>n.id!==currentNoteId);localStorage.setItem('enercon_notes',JSON.stringify(notes));currentNoteId=null;document.getElementById('noteTitle').value='';document.getElementById('noteContent').value='';renderNotes();showToast('Deleted');updateMemoryStats()}
        function syncNoteToRAG(){const t=document.getElementById('noteTitle').value.trim(),c=document.getElementById('noteContent').value.trim();if(!c)return;ws.send(JSON.stringify({action:'sync_note',title:t||'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·',content:c}))}

        // Calendar
        function renderCalendar(){const months=['Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚','Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚','ÎœÎ¬ÏÏ„Î¹Î¿Ï‚','Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚','ÎœÎ¬Î¹Î¿Ï‚','Î™Î¿ÏÎ½Î¹Î¿Ï‚','Î™Î¿ÏÎ»Î¹Î¿Ï‚','Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚','Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚','ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚','ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚','Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚'];document.getElementById('calendarMonth').textContent=`${months[currentMonth]} ${currentYear}`;const firstDay=new Date(currentYear,currentMonth,1).getDay(),daysInMonth=new Date(currentYear,currentMonth+1,0).getDate(),today=new Date(),todayStr=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;if(!selectedDate)selectedDate=todayStr;document.getElementById('eventDate').value=selectedDate;let html='';for(let i=0;i<firstDay;i++)html+='<div class="calendar-day" style="opacity:0.3;"></div>';for(let d=1;d<=daysInMonth;d++){const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,isToday=dateStr===todayStr,isSelected=dateStr===selectedDate,hasEvent=events.some(e=>e.date===dateStr);html+=`<div class="calendar-day ${isToday?'today':''} ${isSelected?'selected':''} ${hasEvent?'has-event':''}" onclick="selectDate('${dateStr}')">${d}</div>`}document.getElementById('calendarDays').innerHTML=html;renderEvents()}
        function prevMonth(){if(currentMonth===0){currentMonth=11;currentYear--}else currentMonth--;renderCalendar()}
        function nextMonth(){if(currentMonth===11){currentMonth=0;currentYear++}else currentMonth++;renderCalendar()}
        function goToday(){const t=new Date();currentMonth=t.getMonth();currentYear=t.getFullYear();selectedDate=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;renderCalendar()}
        function selectDate(date){selectedDate=date;document.getElementById('eventDate').value=date;renderCalendar()}
        function renderEvents(){const dateEvents=events.filter(e=>e.date===selectedDate).sort((a,b)=>(a.time||'').localeCompare(b.time||''));document.getElementById('selectedDateLabel').textContent=selectedDate?` - ${selectedDate.split('-').reverse().join('/')}`:'';document.getElementById('eventsList').innerHTML=dateEvents.length?dateEvents.map(e=>`<div class="event-item ${e.googleId?'google':''}"><button class="event-delete" onclick="deleteEvent('${e.id}')"><i class="fas fa-times"></i></button><h4 style="padding-right:25px;">${e.title}${e.googleId?'<span style="font-size:0.7em;padding:2px 6px;border-radius:4px;background:#4285f4;margin-left:5px;">Google</span>':''}</h4><p style="color:#888;font-size:0.85em;"><i class="fas fa-clock"></i> ${e.time||'ÎŒÎ»Î· Î¼Î­ÏÎ±'}</p>${e.desc?`<p style="color:#888;font-size:0.85em;">${e.desc}</p>`:''}</div>`).join(''):'<p style="color:#888;">ÎšÎ±Î½Î­Î½Î±</p>'}
        function addEvent(){const t=document.getElementById('eventTitle').value.trim(),date=document.getElementById('eventDate').value,time=document.getElementById('eventTime').value,desc=document.getElementById('eventDesc').value.trim();if(!t||!date)return showToast('Î¤Î¯Ï„Î»Î¿Ï‚ & Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±',true);events.push({id:Date.now().toString(),title:t,date,time,desc});localStorage.setItem('enercon_events',JSON.stringify(events));document.getElementById('eventTitle').value='';document.getElementById('eventTime').value='';document.getElementById('eventDesc').value='';renderCalendar();showToast('Added!');updateMemoryStats()}
        function deleteEvent(id){if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))return;events=events.filter(e=>e.id!==id);localStorage.setItem('enercon_events',JSON.stringify(events));renderCalendar();showToast('Deleted');updateMemoryStats()}
        function fetchGoogleCalendar(){ws.send(JSON.stringify({action:'fetch_calendar'}));showToast('Syncing...')}
        function displayGoogleEvents(gEvents){let added=0;gEvents.forEach(e=>{if(!events.some(x=>x.googleId===e.id)){events.push({id:Date.now().toString()+Math.random(),googleId:e.id,title:e.summary||'Event',date:e.start?.date||(e.start?.dateTime||'').split('T')[0],time:(e.start?.dateTime||'').split('T')[1]?.substring(0,5)||'',desc:e.description||''});added++}});localStorage.setItem('enercon_events',JSON.stringify(events));renderCalendar();showToast(`Synced ${added}!`);updateMemoryStats()}

        // Upload
        const uz=document.getElementById('uploadZone'),fi=document.getElementById('fileInput');uz.onclick=()=>fi.click();uz.ondragover=e=>{e.preventDefault();uz.style.borderColor='#f39c12'};uz.ondragleave=()=>uz.style.borderColor='#444';uz.ondrop=e=>{e.preventDefault();uz.style.borderColor='#444';handleFiles(e.dataTransfer.files)};fi.onchange=()=>handleFiles(fi.files);
        function handleFiles(files){for(const f of files){pendingFiles.push(f);document.getElementById('fileList').innerHTML+=`<div class="file-item"><span><i class="fas fa-file"></i> ${f.name}</span><span style="color:#888;">Ready</span></div>`}}
        async function uploadAllFiles(){if(!ws)return;const cat=document.getElementById('uploadCategory').value;for(const f of pendingFiles){const r=new FileReader();r.onload=()=>ws.send(JSON.stringify({action:'upload_file',file_data:r.result.split(',')[1],filename:f.name,category:cat}));r.readAsDataURL(f);await new Promise(r=>setTimeout(r,500))}pendingFiles=[];document.getElementById('fileList').innerHTML=''}

        // Docs
        function loadDocs(){if(!ws)return;document.getElementById('docsList').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';ws.send(JSON.stringify({action:'list'}))}
        function displayDocs(docs){document.getElementById('docsList').innerHTML=docs.map(d=>`<div class="doc-card"><span class="result-category ${d.category}"><i class="fas fa-tag"></i> ${d.category}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.title}</span><button class="delete-btn" onclick="deleteDoc('${d.id}')"><i class="fas fa-trash"></i></button></div>`).join('')}
        function deleteDoc(id){if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))ws.send(JSON.stringify({action:'delete',doc_id:id}))}

        // Settings
        function loadSettings(){document.getElementById('toggleAutoSync').classList.toggle('active',settings.autoSync);if(settings.lastSync)document.getElementById('settingsLastSync').textContent=new Date(settings.lastSync).toLocaleTimeString('el-GR')}
        function resetToken(){if(confirm('Reset token;'))showToast('Delete token.pickle & restart')}
        function clearLocalData(){if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½;')){localStorage.clear();notes=[];events=[];settings={autoSync:false};showToast('Cleared!');updateMemoryStats()}}

        // Utils
        function showToast(m,err=false){const t=document.getElementById('toast');t.innerHTML=`<i class="fas fa-${err?'exclamation-triangle':'check-circle'}"></i> ${m}`;t.style.background=err?'#e74c3c':'#27ae60';t.style.display='block';setTimeout(()=>t.style.display='none',3000)}

        // Init
        document.getElementById('searchInput').onkeypress=e=>{if(e.key==='Enter')doSearch()};
        document.getElementById('helpModal').onclick=e=>{if(e.target.id==='helpModal')closeHelp()};
        document.getElementById('emailModal').onclick=e=>{if(e.target.id==='emailModal')closeEmailModal()};
        document.getElementById('aiModal').onclick=e=>{if(e.target.id==='aiModal')closeAI()};
        connect();
        if(settings.autoSync)document.getElementById('autoSyncBadge').classList.add('active');
    </script>
</body>
</html>
    </div>

    <!-- EMAIL MODAL -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="emailModalTitle"></span>
                <button class="modal-close" onclick="closeEmailModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="emailModalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let ws, pendingFiles=[], emailsData=[], selectedEmails=new Set(), contactsData=[], totalDocs=0;
        let notes = JSON.parse(localStorage.getItem('enercon_notes') || '[]');
        let events = JSON.parse(localStorage.getItem('enercon_events') || '[]');
        let settings = JSON.parse(localStorage.getItem('enercon_settings') || '{"autoSync":false,"useRAG":true}');
        let prompts = JSON.parse(localStorage.getItem('enercon_prompts') || '{}');
        let currentNoteId = null, currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear(), selectedDate = null;
        let autoSyncInterval = null, currentAIAction = null, selectedTemplate = null;

        const defaultPrompts = {
            search: 'Î’Î¿Î®Î¸Î·ÏƒÎµ Î¼Îµ Ï„Î·Î½ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½ ÎºÎ±Î¹ Ï„Î¹Î¼ÏÎ½. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ RAG context Î³Î¹Î± Î±ÎºÏÎ¹Î²ÎµÎ¯Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.',
            quote: 'Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ® Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ Ï†Ï‰Ï„Î¿Î²Î¿Î»Ï„Î±ÏŠÎºÎ¿Ï. Î£Ï…Î¼Ï€ÎµÏÎ¯Î»Î±Î²Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±, Ï„Î¹Î¼Î­Ï‚, ÎµÎ³Î³ÏÎ·ÏƒÎ·.',
            email: 'Î£ÏÎ½Ï„Î±Î¾Îµ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒ email. Î¤ÏŒÎ½Î¿Ï‚ Ï†Î¹Î»Î¹ÎºÏŒÏ‚ Î±Î»Î»Î¬ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒÏ‚.',
            general: 'Î•Î¯ÏƒÎ±Î¹ Î¿ AI Î²Î¿Î·Î¸ÏŒÏ‚ Ï„Î¿Ï… Enercon. Î’Î¿Î·Î¸Î¬Ï‚ Î¼Îµ Ï†Ï‰Ï„Î¿Î²Î¿Î»Ï„Î±ÏŠÎºÎ¬, Ï„Î¹Î¼Î­Ï‚, ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚.'
        };

        const emailTemplates = {
            quote: { name: 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬Ï‚', subject: 'Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ Î¦Ï‰Ï„Î¿Î²Î¿Î»Ï„Î±ÏŠÎºÎ¿Ï - {customer_name}', body: 'Î‘Î³Î±Ï€Î·Ï„Î­/Î® {customer_name},\n\nÎ£Î±Ï‚ Î±Ï€Î¿ÏƒÏ„Î­Î»Î»Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ Î³Î¹Î± Ï†Ï‰Ï„Î¿Î²Î¿Î»Ï„Î±ÏŠÎºÏŒ ÏƒÏÏƒÏ„Î·Î¼Î±.\n\nÎ ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹:\n{items}\n\nÎ£ÏÎ½Î¿Î»Î¿: â‚¬{total}\n\nÎ™ÏƒÏ‡ÏÎµÎ¹ 30 Î·Î¼Î­ÏÎµÏ‚.\n\nÎœÎµ ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·,\nEnercon Team' },
            followup: { name: 'Follow-up', subject: 'Re: Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ - Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·', body: 'Î‘Î³Î±Ï€Î·Ï„Î­/Î® {customer_name},\n\nÎ•Ï€Î±Î½ÎµÏÏ‡ÏŒÎ¼Î±ÏƒÏ„Îµ Î³Î¹Î± Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ Ï„Î·Ï‚ {date}.\n\nÎˆÏ‡ÎµÏ„Îµ Î±Ï€Î¿ÏÎ¯ÎµÏ‚;\n\nÎœÎµ ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·,\nEnercon Team' },
            thankyou: { name: 'Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î®ÏÎ¹Î¿', subject: 'Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ!', body: 'Î‘Î³Î±Ï€Î·Ï„Î­/Î® {customer_name},\n\nÎ£Î±Ï‚ ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ Î³Î¹Î± Ï„Î·Î½ ÎµÎ¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·!\n\nÎ•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: {date}\nÎ¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚: {technician}\n\nÎœÎµ ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·,\nEnercon Team' },
            reminder: { name: 'Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·', subject: 'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·Ï‚', body: 'Î‘Î³Î±Ï€Î·Ï„Î­/Î® {customer_name},\n\nÎ Î»Î·ÏƒÎ¹Î¬Î¶ÎµÎ¹ Î· ÎµÏ„Î®ÏƒÎ¹Î± ÏƒÏ…Î½Ï„Î®ÏÎ·ÏƒÎ·.\n\nâ€¢ ÎœÎ­Î³Î¹ÏƒÏ„Î· Î±Ï€ÏŒÎ´Î¿ÏƒÎ·\nâ€¢ Î Î±ÏÎ¬Ï„Î±ÏƒÎ· ÎµÎ³Î³ÏÎ·ÏƒÎ·Ï‚\nâ€¢ Î ÏÏŒÎ»Î·ÏˆÎ· Î²Î»Î±Î²ÏÎ½\n\nÎšÎ±Î»Î­ÏƒÏ„Îµ: 210 1234567\n\nÎœÎµ ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·,\nEnercon Team' }
        };

        // DateTime
        function updateDateTime() {
            const now = new Date();
            const days = ['ÎšÏ…ÏÎ¹Î±ÎºÎ®','Î”ÎµÏ…Ï„Î­ÏÎ±','Î¤ÏÎ¯Ï„Î·','Î¤ÎµÏ„Î¬ÏÏ„Î·','Î Î­Î¼Ï€Ï„Î·','Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®','Î£Î¬Î²Î²Î±Ï„Î¿'];
            const months = ['Î™Î±Î½','Î¦ÎµÎ²','ÎœÎ±Ï','Î‘Ï€Ï','ÎœÎ±ÏŠ','Î™Î¿Ï…Î½','Î™Î¿Ï…Î»','Î‘Ï…Î³','Î£ÎµÏ€','ÎŸÎºÏ„','ÎÎ¿Îµ','Î”ÎµÎº'];
            document.getElementById('currentDate').textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('el-GR');
        }
        setInterval(updateDateTime, 1000); updateDateTime();

        // WebSocket
        function connect() {
            ws = new WebSocket('ws://localhost:8765');
            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                ws.send(JSON.stringify({action:'stats'}));
                if(settings.claudeKey) ws.send(JSON.stringify({action:'set_claude_key', api_key: settings.claudeKey}));
                if(settings.autoSync) startAutoSync();
            };
            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';
                setTimeout(connect, 3000);
            };
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                if(d.action==='search_results') displayResults(d.results);
                else if(d.action==='stats') { totalDocs=d.data.total_vectors; document.getElementById('statsText').textContent=`| ${totalDocs} docs`; updateMemoryStats(); }
                else if(d.action==='file_upload_success'){showToast(`Uploaded ${d.count}`);ws.send(JSON.stringify({action:'stats'}))}
                else if(d.action==='emails_loaded') displayEmails(d.emails);
                else if(d.action==='email_sync_success') addSyncLog(d.subject,'success');
                else if(d.action==='email_sync_complete'){addSyncLog(`Done! ${d.count}`,'success');showToast(`Synced ${d.count}!`)}
                else if(d.action==='list_results') displayDocs(d.docs);
                else if(d.action==='delete_success'){showToast('Deleted');loadDocs()}
                else if(d.action==='note_synced') showToast('Note synced!');
                else if(d.action==='calendar_events') displayGoogleEvents(d.events);
                else if(d.action==='contacts_loaded') displayContacts(d.contacts);
                else if(d.action==='ai_response') displayAIResponse(d.response);
                else if(d.action==='claude_key_set') showToast(d.success?'Claude API OK!':'Claude Error',!d.success);
                else if(d.action==='pdf_generated') handlePDF(d);
                else if(d.action==='error') showToast(d.message,true);
            };
        }

        function updateMemoryStats() {
            const maxDocs = 10000;
            const percent = Math.min(100, (totalDocs / maxDocs) * 100);
            document.getElementById('memoryPercent').textContent = percent.toFixed(1) + '%';
            document.getElementById('memoryBar').style.width = percent + '%';
            document.getElementById('memDocs').textContent = totalDocs;
            document.getElementById('memNotes').textContent = notes.length;
            document.getElementById('memEvents').textContent = events.length;
            document.getElementById('memEmails').textContent = Math.floor(totalDocs * 0.3);
        }

        // Panels
        function showPanel(n) {
            document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.getElementById(n+'Panel').classList.add('active');
            const tab = document.querySelector(`.tab[onclick="showPanel('${n}')"]`);
            if(tab) tab.classList.add('active');
            if(n==='docs')loadDocs();
            if(n==='notes')renderNotes();
            if(n==='calendar')renderCalendar();
            if(n==='settings'){loadSettings();updateMemoryStats();}
        }
        function showHelp(){document.getElementById('helpModal').classList.add('active')}
        function closeHelp(){document.getElementById('helpModal').classList.remove('active')}

        // AI Modal
        function showAI() { 
            document.getElementById('aiModal').classList.add('active'); 
            document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
            loadPrompts();
        }
        function closeAI() { document.getElementById('aiModal').classList.remove('active'); }
        
        function showAITab(tab) {
            document.querySelectorAll('.ai-tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.ai-panel').forEach(p=>p.classList.remove('active'));
            event.target.closest('.ai-tab').classList.add('active');
            document.getElementById('aiPanel'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
        }

        function startAIChat(action) {
            currentAIAction = action;
            document.getElementById('aiOptions').style.display = 'none';
            document.getElementById('aiChatBox').style.display = 'block';
            document.getElementById('aiMessages').innerHTML = '';
            document.getElementById('aiSuggestions').innerHTML = '';
            
            let msg = '', suggestions = [];
            if(action === 'search') { msg = 'Î¤Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚;'; suggestions = ['Î¤Î¹Î¼Î­Ï‚ inverter', 'Panels 500W', 'ÎœÏ€Î±Ï„Î±ÏÎ¯ÎµÏ‚']; }
            else if(action === 'quote') { msg = 'Î‘Ï‚ Ï†Ï„Î¹Î¬Î¾Î¿Ï…Î¼Îµ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬! Î ÎµÏ‚ Î¼Î¿Ï…:\nâ€¢ Î¤Î¹ ÎµÎ¾Î¿Ï€Î»Î¹ÏƒÎ¼ÏŒ;\nâ€¢ Î ÏŒÏƒÎ± kW;\nâ€¢ Î ÎµÎ»Î¬Ï„Î·Ï‚;'; suggestions = ['5kW Î¿Î¹ÎºÎ¹Î±ÎºÏŒ', '10kW ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒ']; }
            else if(action === 'email') { msg = 'Î¤Î¹ email Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î³ÏÎ¬ÏˆÏ‰;'; suggestions = ['Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬', 'Follow-up', 'Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î®ÏÎ¹Î¿']; }
            else if(action === 'help') { msg = 'Î¡ÏÏ„Î± Î¼Îµ Î³Î¹Î± Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®!'; suggestions = ['Î ÏÏ‚ Î±Î½ÎµÎ²Î¬Î¶Ï‰;', 'Î¤Î¹ ÎµÎ¯Î½Î±Î¹ RAG;', 'Î ÏÏ‚ Ï†Ï„Î¹Î¬Ï‡Î½Ï‰ PDF;']; }
            
            addAIMessage(msg, 'assistant');
            suggestions.forEach(s => {
                document.getElementById('aiSuggestions').innerHTML += `<span class="ai-suggestion" onclick="document.getElementById('aiInput').value='${s}';sendAI()">${s}</span>`;
            });
        }

        function addAIMessage(text, type) {
            const div = document.createElement('div');
            div.className = 'ai-message ' + type;
            div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            document.getElementById('aiMessages').appendChild(div);
            document.getElementById('aiMessages').scrollTop = 99999;
        }

        function sendAI() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            if(!text || !ws) return;
            
            addAIMessage(text, 'user');
            input.value = '';
            document.getElementById('aiSuggestions').innerHTML = '';
            
            addAIMessage('Î£ÎºÎ­Ï†Ï„Î¿Î¼Î±Î¹...', 'assistant loading');
            
            ws.send(JSON.stringify({
                action: 'ai_chat',
                message: text,
                ai_action: currentAIAction,
                settings: { useRAG: settings.useRAG }
            }));
        }

        function displayAIResponse(response) {
            const msgs = document.getElementById('aiMessages');
            const loading = msgs.querySelector('.loading');
            if(loading) loading.remove();
            addAIMessage(response, 'assistant');
        }

        // Quote Builder
        function addQuoteItem() {
            const html = `<div class="quote-item">
                <input type="text" placeholder="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®" class="item-name">
                <input type="number" placeholder="Qty" class="item-qty" value="1" onchange="calcTotal()">
                <input type="number" placeholder="â‚¬" class="item-price" onchange="calcTotal()">
                <button class="remove-item" onclick="this.parentElement.remove();calcTotal()"><i class="fas fa-times"></i></button>
            </div>`;
            document.getElementById('quoteItems').insertAdjacentHTML('beforeend', html);
        }

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('.quote-item').forEach(item => {
                const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                total += qty * price;
            });
            document.getElementById('quoteTotal').textContent = total.toFixed(2);
        }

        function aiGenerateQuote() {
            const name = document.getElementById('customerName').value;
            if(!name) return showToast('Î’Î¬Î»Îµ ÏŒÎ½Î¿Î¼Î± Ï€ÎµÎ»Î¬Ï„Î·', true);
            addAIMessage('Î¨Î¬Ï‡Î½Ï‰ Ï„Î¹Î¼Î­Ï‚ ÎºÎ±Î¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Ï Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬...', 'assistant');
            ws.send(JSON.stringify({
                action: 'ai_chat',
                message: `Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ Î³Î¹Î± ${name}. Î ÏÏŒÏ„ÎµÎ¹Î½Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÎºÎ±Î¹ Ï„Î¹Î¼Î­Ï‚.`,
                ai_action: 'quote',
                settings: { useRAG: true }
            }));
        }

        function generatePDF() {
            const items = [];
            document.querySelectorAll('.quote-item').forEach(item => {
                const name = item.querySelector('.item-name').value;
                const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                if(name) items.push({ name, qty, price });
            });
            
            if(!items.length) return showToast('Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±', true);
            
            ws.send(JSON.stringify({
                action: 'generate_pdf',
                quote_data: {
                    number: document.getElementById('quoteNumber').value || '001',
                    date: document.getElementById('quoteDate').value,
                    customer_name: document.getElementById('customerName').value,
                    customer_email: document.getElementById('customerEmail').value,
                    customer_phone: document.getElementById('customerPhone').value,
                    items: items,
                    notes: document.getElementById('quoteNotes').value
                }
            }));
            showToast('Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF...');
        }

        function handlePDF(data) {
            if(data.success) {
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + data.data;
                link.download = data.filename;
                link.click();
                showToast('PDF Î­Ï„Î¿Î¹Î¼Î¿!');
            } else {
                showToast('PDF Error: ' + data.error, true);
            }
        }

        // Email Templates
        function selectTemplate(id) {
            selectedTemplate = id;
            const t = emailTemplates[id];
            document.getElementById('templatePreview').style.display = 'block';
            document.getElementById('templateName').textContent = t.name;
            document.getElementById('templateSubject').textContent = 'ğŸ“§ ' + t.subject;
            document.getElementById('templateBody').textContent = t.body;
        }

        function copyTemplate() {
            if(!selectedTemplate) return;
            const t = emailTemplates[selectedTemplate];
            navigator.clipboard.writeText(t.subject + '\n\n' + t.body);
            showToast('Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!');
        }

        function editTemplateWithAI() {
            if(!selectedTemplate) return;
            showAITab('chat');
            startAIChat('email');
            document.getElementById('aiInput').value = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î¬ÏƒÎ¿Ï… Ï„Î¿ template: ' + emailTemplates[selectedTemplate].name;
        }

        // Prompts
        function loadPrompts() {
            const saved = JSON.parse(localStorage.getItem('enercon_prompts') || '{}');
            document.getElementById('promptSearch').value = saved.search || defaultPrompts.search;
            document.getElementById('promptQuote').value = saved.quote || defaultPrompts.quote;
            document.getElementById('promptEmail').value = saved.email || defaultPrompts.email;
            document.getElementById('promptGeneral').value = saved.general || defaultPrompts.general;
        }

        function savePrompts() {
            const p = {
                search: document.getElementById('promptSearch').value,
                quote: document.getElementById('promptQuote').value,
                email: document.getElementById('promptEmail').value,
                general: document.getElementById('promptGeneral').value
            };
            localStorage.setItem('enercon_prompts', JSON.stringify(p));
            showToast('Prompts Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!');
        }

        function resetPrompt(type) {
            document.getElementById('prompt' + type.charAt(0).toUpperCase() + type.slice(1)).value = defaultPrompts[type];
        }

        // Settings
        function saveClaudeKey() {
            const key = document.getElementById('claudeApiKey').value;
            settings.claudeKey = key;
            localStorage.setItem('enercon_settings', JSON.stringify(settings));
            ws.send(JSON.stringify({action:'set_claude_key', api_key: key}));
        }

        function toggleSetting(key) {
            settings[key] = !settings[key];
            localStorage.setItem('enercon_settings', JSON.stringify(settings));
            const el = document.getElementById('toggle' + key.charAt(0).toUpperCase() + key.slice(1));
            if(el) el.classList.toggle('active', settings[key]);
        }

        function loadSettings() {
            document.getElementById('toggleAutoSync').classList.toggle('active', settings.autoSync);
            document.getElementById('toggleUseRAG').classList.toggle('active', settings.useRAG !== false);
            if(settings.claudeKey) document.getElementById('claudeApiKey').value = settings.claudeKey;
        }

        // Auto-Sync
        function toggleAutoSync(){settings.autoSync=!settings.autoSync;localStorage.setItem('enercon_settings',JSON.stringify(settings));document.getElementById('toggleAutoSync').classList.toggle('active',settings.autoSync);document.getElementById('autoSyncBadge').classList.toggle('active',settings.autoSync);if(settings.autoSync)startAutoSync();else stopAutoSync();showToast(settings.autoSync?'Auto-sync ON':'OFF')}
        function startAutoSync(){if(autoSyncInterval)return;autoSyncInterval=setInterval(()=>{const d=new Date();d.setDate(d.getDate()-7);ws.send(JSON.stringify({action:'fetch_emails',query:`category:primary after:${d.toISOString().split('T')[0]}`,max_results:20}))},10*60*1000);document.getElementById('autoSyncBadge').classList.add('active')}
        function stopAutoSync(){if(autoSyncInterval){clearInterval(autoSyncInterval);autoSyncInterval=null}document.getElementById('autoSyncBadge').classList.remove('active')}

        // Search
        function doSearch(){const q=document.getElementById('searchInput').value.trim();if(!q||!ws)return;document.getElementById('results').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';ws.send(JSON.stringify({action:'search',query:q,top_k:15}))}
        function displayResults(r){document.getElementById('resultsCount').textContent=r.length?`${r.length} Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±`:'';if(!r.length){document.getElementById('results').innerHTML='<div class="loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';return}document.getElementById('results').innerHTML=r.map(x=>`<div class="result-card"><div class="result-header"><span class="result-title">${x.title}</span><span class="result-score">${x.score}</span></div><span class="result-category">${x.category}</span><div class="result-text">${x.text}</div></div>`).join('')}

        // Email
        function fetchEmails(){const cat=document.getElementById('emailCategory').value,days=document.getElementById('emailDays').value,filt=document.getElementById('emailFilter').value,search=document.getElementById('emailSearch').value;document.getElementById('emailList').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';let q='';if(cat==='primary')q+='category:primary ';else if(cat==='updates')q+='category:updates ';else if(cat==='sent')q+='in:sent ';if(filt==='attachments')q+='has:attachment ';if(search)q+=search+' ';const d=new Date();d.setDate(d.getDate()-parseInt(days));q+=`after:${d.toISOString().split('T')[0]}`;ws.send(JSON.stringify({action:'fetch_emails',query:q.trim(),max_results:50}))}
        function displayEmails(emails){emailsData=emails;selectedEmails.clear();updateSelectedCount();if(!emails.length){document.getElementById('emailList').innerHTML='<div class="loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';return}document.getElementById('emailList').innerHTML=emails.map((e,i)=>`<div class="email-item" onclick="showEmailPreview(${i})"><input type="checkbox" class="email-checkbox" id="email-${i}" onclick="event.stopPropagation();toggleEmailCheckbox(${i})"><div><div style="color:#fff;">${e.subject}</div><div style="color:#888;font-size:0.8em;">${e.from} | ${e.date}</div></div><span style="padding:4px 10px;border-radius:12px;font-size:0.75em;background:#3498db;">${e.categoryLabel}</span></div>`).join('')}
        function toggleEmailCheckbox(i){selectedEmails.has(i)?selectedEmails.delete(i):selectedEmails.add(i);updateSelectedCount()}
        function toggleSelectAll(){const s=document.getElementById('selectAll').checked;emailsData.forEach((_,i)=>{s?selectedEmails.add(i):selectedEmails.delete(i);const cb=document.getElementById(`email-${i}`);if(cb)cb.checked=s});updateSelectedCount()}
        function updateSelectedCount(){document.getElementById('selectedCount').textContent=selectedEmails.size;document.getElementById('btnSync').disabled=!selectedEmails.size}
        function showEmailPreview(i){const e=emailsData[i];document.getElementById('emailModalTitle').innerHTML=`<i class="fas fa-envelope"></i> ${e.subject}`;document.getElementById('emailModalBody').innerHTML=`<p><b>Î‘Ï€ÏŒ:</b> ${e.from}</p><p><b>Î—Î¼:</b> ${e.date}</p><hr style="border-color:#444;margin:15px 0;"><div style="background:#1a1a2e;padding:15px;border-radius:8px;">${e.snippet}</div>`;document.getElementById('emailModal').classList.add('active')}
        function closeEmailModal(){document.getElementById('emailModal').classList.remove('active')}
        function syncSelectedEmails(){if(!selectedEmails.size)return;document.getElementById('syncStatus').style.display='block';document.getElementById('syncLog').innerHTML='';addSyncLog(`Sync ${selectedEmails.size}...`,'info');ws.send(JSON.stringify({action:'sync_emails',emails:Array.from(selectedEmails).map(i=>emailsData[i])}))}
        function addSyncLog(m,t='info'){const l=document.getElementById('syncLog'),e=document.createElement('div');e.className=t;e.innerHTML=`<i class="fas fa-${t==='success'?'check':'info'}-circle"></i> ${m}`;l.appendChild(e)}

        // Contacts
        function fetchContacts(){document.getElementById('contactsList').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';ws.send(JSON.stringify({action:'fetch_contacts'}))}
        function displayContacts(contacts){contactsData=contacts;if(!contacts.length){document.getElementById('contactsList').innerHTML='<div class="loading">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';return}renderContacts(contacts)}
        function renderContacts(list){document.getElementById('contactsList').innerHTML=list.map(c=>`<div class="contact-card"><h3><i class="fas fa-user"></i> ${c.name}</h3><div class="contact-info">${c.phones.map(p=>`<span><i class="fas fa-phone"></i> <a href="tel:${p}">${p}</a></span>`).join('')}${c.emails.map(e=>`<span><i class="fas fa-envelope"></i> <a href="mailto:${e}">${e}</a></span>`).join('')}</div></div>`).join('')}
        function filterContacts(){const q=document.getElementById('contactsSearch').value.toLowerCase();renderContacts(contactsData.filter(c=>c.name.toLowerCase().includes(q)||c.emails.some(e=>e.toLowerCase().includes(q))))}

        // Notes
        function renderNotes(){document.getElementById('notesList').innerHTML=notes.map(n=>`<div class="note-item ${currentNoteId===n.id?'active':''}" onclick="loadNote('${n.id}')"><h4 style="margin-bottom:5px;">${n.title||'Î§Ï‰ÏÎ¯Ï‚ Ï„Î¯Ï„Î»Î¿'}</h4><small style="color:#888;">${new Date(n.updated).toLocaleDateString('el-GR')}</small></div>`).join('')||'<p style="color:#888;text-align:center;">ÎšÎ±Î¼Î¯Î±</p>'}
        function newNote(){currentNoteId=Date.now().toString();document.getElementById('noteTitle').value='';document.getElementById('noteContent').value='';renderNotes()}
        function loadNote(id){const n=notes.find(x=>x.id===id);if(n){currentNoteId=id;document.getElementById('noteTitle').value=n.title;document.getElementById('noteContent').value=n.content;renderNotes()}}
        function saveNote(){const t=document.getElementById('noteTitle').value.trim(),c=document.getElementById('noteContent').value.trim();if(!t&&!c)return;const idx=notes.findIndex(n=>n.id===currentNoteId);const note={id:currentNoteId,title:t,content:c,updated:Date.now()};if(idx>=0)notes[idx]=note;else notes.unshift(note);localStorage.setItem('enercon_notes',JSON.stringify(notes));renderNotes();showToast('Saved!')}
        function deleteNote(){if(!currentNoteId||!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))return;notes=notes.filter(n=>n.id!==currentNoteId);localStorage.setItem('enercon_notes',JSON.stringify(notes));currentNoteId=null;document.getElementById('noteTitle').value='';document.getElementById('noteContent').value='';renderNotes();showToast('Deleted')}
        function syncNoteToRAG(){const t=document.getElementById('noteTitle').value.trim(),c=document.getElementById('noteContent').value.trim();if(!c)return;ws.send(JSON.stringify({action:'sync_note',title:t||'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·',content:c}))}

        // Calendar
        function renderCalendar(){const months=['Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚','Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚','ÎœÎ¬ÏÏ„Î¹Î¿Ï‚','Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚','ÎœÎ¬Î¹Î¿Ï‚','Î™Î¿ÏÎ½Î¹Î¿Ï‚','Î™Î¿ÏÎ»Î¹Î¿Ï‚','Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚','Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚','ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚','ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚','Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚'];document.getElementById('calendarMonth').textContent=`${months[currentMonth]} ${currentYear}`;const firstDay=new Date(currentYear,currentMonth,1).getDay(),daysInMonth=new Date(currentYear,currentMonth+1,0).getDate(),today=new Date(),todayStr=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;if(!selectedDate)selectedDate=todayStr;document.getElementById('eventDate').value=selectedDate;let html='';for(let i=0;i<firstDay;i++)html+='<div class="calendar-day" style="opacity:0.3;"></div>';for(let d=1;d<=daysInMonth;d++){const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,isToday=dateStr===todayStr,isSelected=dateStr===selectedDate,hasEvent=events.some(e=>e.date===dateStr);html+=`<div class="calendar-day ${isToday?'today':''} ${isSelected?'selected':''} ${hasEvent?'has-event':''}" onclick="selectDate('${dateStr}')">${d}</div>`}document.getElementById('calendarDays').innerHTML=html;renderEvents()}
        function prevMonth(){if(currentMonth===0){currentMonth=11;currentYear--}else currentMonth--;renderCalendar()}
        function nextMonth(){if(currentMonth===11){currentMonth=0;currentYear++}else currentMonth++;renderCalendar()}
        function goToday(){const t=new Date();currentMonth=t.getMonth();currentYear=t.getFullYear();selectedDate=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;renderCalendar()}
        function selectDate(date){selectedDate=date;document.getElementById('eventDate').value=date;renderCalendar()}
        function renderEvents(){const dateEvents=events.filter(e=>e.date===selectedDate);document.getElementById('selectedDateLabel').textContent=selectedDate?` - ${selectedDate.split('-').reverse().join('/')}`:'';document.getElementById('eventsList').innerHTML=dateEvents.length?dateEvents.map(e=>`<div class="event-item"><button class="event-delete" onclick="deleteEvent('${e.id}')"><i class="fas fa-times"></i></button><h4 style="padding-right:25px;">${e.title}</h4><p style="color:#888;font-size:0.85em;">${e.time||'ÎŒÎ»Î· Î¼Î­ÏÎ±'}</p></div>`).join(''):'<p style="color:#888;">ÎšÎ±Î½Î­Î½Î±</p>'}
        function addEvent(){const t=document.getElementById('eventTitle').value.trim(),date=document.getElementById('eventDate').value,time=document.getElementById('eventTime').value,desc=document.getElementById('eventDesc').value.trim();if(!t||!date)return;events.push({id:Date.now().toString(),title:t,date,time,desc});localStorage.setItem('enercon_events',JSON.stringify(events));document.getElementById('eventTitle').value='';document.getElementById('eventTime').value='';document.getElementById('eventDesc').value='';renderCalendar();showToast('Added!')}
        function deleteEvent(id){events=events.filter(e=>e.id!==id);localStorage.setItem('enercon_events',JSON.stringify(events));renderCalendar();showToast('Deleted')}
        function fetchGoogleCalendar(){ws.send(JSON.stringify({action:'fetch_calendar'}));showToast('Syncing...')}
        function displayGoogleEvents(gEvents){let added=0;gEvents.forEach(e=>{if(!events.some(x=>x.googleId===e.id)){events.push({id:Date.now().toString()+Math.random(),googleId:e.id,title:e.summary||'Event',date:e.start?.date||(e.start?.dateTime||'').split('T')[0],time:(e.start?.dateTime||'').split('T')[1]?.substring(0,5)||''});added++}});localStorage.setItem('enercon_events',JSON.stringify(events));renderCalendar();showToast(`Synced ${added}!`)}

        // Upload
        const uz=document.getElementById('uploadZone'),fi=document.getElementById('fileInput');uz.onclick=()=>fi.click();uz.ondragover=e=>{e.preventDefault();uz.style.borderColor='#f39c12'};uz.ondragleave=()=>uz.style.borderColor='#444';uz.ondrop=e=>{e.preventDefault();uz.style.borderColor='#444';handleFiles(e.dataTransfer.files)};fi.onchange=()=>handleFiles(fi.files);
        function handleFiles(files){for(const f of files){pendingFiles.push(f);document.getElementById('fileList').innerHTML+=`<div class="file-item"><span>${f.name}</span><span style="color:#888;">Ready</span></div>`}}
        async function uploadAllFiles(){if(!ws)return;const cat=document.getElementById('uploadCategory').value;for(const f of pendingFiles){const r=new FileReader();r.onload=()=>ws.send(JSON.stringify({action:'upload_file',file_data:r.result.split(',')[1],filename:f.name,category:cat}));r.readAsDataURL(f);await new Promise(r=>setTimeout(r,500))}pendingFiles=[];document.getElementById('fileList').innerHTML=''}

        // Docs
        function loadDocs(){if(!ws)return;document.getElementById('docsList').innerHTML='<div class="loading"><span class="loading-spinner"></span></div>';ws.send(JSON.stringify({action:'list'}))}
        function displayDocs(docs){document.getElementById('docsList').innerHTML=docs.map(d=>`<div class="doc-card"><span class="result-category">${d.category}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.title}</span><button class="delete-btn" onclick="deleteDoc('${d.id}')"><i class="fas fa-trash"></i></button></div>`).join('')}
        function deleteDoc(id){if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;'))ws.send(JSON.stringify({action:'delete',doc_id:id}))}

        function resetToken(){if(confirm('Reset;'))showToast('Delete token.pickle')}
        function clearLocalData(){if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;')){localStorage.clear();notes=[];events=[];settings={};showToast('Done!')}}

        function showToast(m,err=false){const t=document.getElementById('toast');t.innerHTML=`<i class="fas fa-${err?'exclamation-triangle':'check-circle'}"></i> ${m}`;t.style.background=err?'#e74c3c':'#27ae60';t.style.display='block';setTimeout(()=>t.style.display='none',3000)}

        // Init
        document.getElementById('searchInput').onkeypress=e=>{if(e.key==='Enter')doSearch()};
        document.getElementById('helpModal').onclick=e=>{if(e.target.id==='helpModal')closeHelp()};
        document.getElementById('emailModal').onclick=e=>{if(e.target.id==='emailModal')closeEmailModal()};
        document.getElementById('aiModal').onclick=e=>{if(e.target.id==='aiModal')closeAI()};
        document.querySelectorAll('.quote-item input').forEach(i=>i.addEventListener('change',calcTotal));
        connect();
        if(settings.autoSync)document.getElementById('autoSyncBadge').classList.add('active');
    </script>
</body>
</html>
